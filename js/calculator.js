const BITOVAYA = [
  {opt: "Ручная",
    optDetails: [
      { issue: "Рвет нить", price: "от <span>2500</span> до <span>4500*</span>"},
      { issue: "Не опускается лапка", price: "от <span>2500</span> до <span>4500*</span>"},
      { issue: "Пропускает", price: "от <span>2500</span> до <span>4500*</span>"},
      { issue: "Петляет", price: "от <span>2500</span> до <span>4500*</span>"},
      { issue: "Стучит", price: "от <span>2500</span> до <span>4500*</span>"},
      { issue: "Медленно шьет", price: "от <span>2500</span> до <span>4500*</span>"},
      { issue: "Заклинило", price: "<span>3500</span> до <span>6500*</span>"},
      { issue: "Чистка, смазка", price: "<span>3500</span>"},
      { issue: "Профессиональное сервисное обслуживание", price: "<span>5500</span>",}
    ]},
  {opt: "Электромеханическая",
    optDetails: [
      { issue: "Рвет нить", price: "от <span>2500</span> до <span>4500*</span>"},
      { issue: "Не опускается лапка", price: "от <span>2500</span> до <span>4500*</span>"},
      { issue: "Пропускает", price: "от <span>2500</span> до <span>4500*</span>"},
      { issue: "Петляет", price: "от <span>2500</span> до <span>4500*</span>"},
      { issue: "Стучит", price: "от <span>2500</span> до <span>4500*</span>"},
      { issue: "Медленно шьет", price: "от <span>2500</span> до <span>4500*</span>"},
      { issue: "Заклинило", price: "<span>3500</span> до <span>6500*</span>"},
      { issue: "Чистка, смазка", price: "<span>3500</span>"},
      { issue: "Профессиональное сервисное обслуживание", price: "<span>5500</span>",}
    ]},
  {opt: "Компьютеризированная",
    optDetails: [
      { issue: "Рвет нить", price: "от <span>3500</span> до <span>5500*</span>"},
      { issue: "Не опускается лапка", price: "от <span>3500</span> до <span>5500*</span>"},
      { issue: "Пропускает", price: "от <span>3500</span> до <span>5500*</span>"},
      { issue: "Петляет", price: "от <span>3500</span> до <span>5500*</span>"},
      { issue: "Стучит", price: "от <span>3500</span> до <span>5500*</span>"},
      { issue: "Медленно шьет", price: "от <span>3500</span> до <span>5500*</span>"},
      { issue: "Заклинило", price: "<span>4500</span> до <span>6500*</span>"},
      { issue: "Ошибка на дисплее", price: "<span>3500</span>" },
      { issue: "Профессиональное сервисное обслуживание", price: "от <span>6500</span> до <span>12500</span>"}
    ]},
  {opt: "Швейно-вышивальная",
    optDetails: [
      { issue: "Рвет нить", price: "<span>4500</span> до <span>6500*</span>"},
      { issue: "Не опускается лапка", price: "цена не указана" },
      { issue: "Пропускает", price: "цена не указана" },
      { issue: "Петляет", price: "цена не указана" },
      { issue: "Стучит", price: "цена не указана" },
      { issue: "Медленно шьет", price: "цена не указана" },
      { issue: "Заклинило", price: "цена не указана" },
      { issue: "Ошибка на дисплее", price: "цена не указана" },
      { issue: "Профессиональное сервисное обслуживание", price: "от <span>6500</span> до <span>12500</span>"}
    ]},
  {opt: "Вышивальная",
    optDetails: [
      { issue: "Рвет нить", price: "цена не указана" },
      { issue: "Не опускается лапка", price: "цена не указана" },
      { issue: "Пропускает", price: "цена не указана" },
      { issue: "Петляет", price: "цена не указана" },
      { issue: "Стучит", price: "цена не указана" },
      { issue: "Медленно шьет", price: "цена не указана" },
      { issue: "Заклинило", price: "цена не указана" },
      { issue: "Ошибка на дисплее", price: "цена не указана" },
      { issue: "Профессиональное сервисное обслуживание", price: "от <span>6500</span> до <span>12500</span>"}
    ]},
  {opt: "Оверлок",
    optDetails: [
      { issue: "Рвет нить", price: "цена не указана" },
      { issue: "Не опускается лапка", price: "цена не указана" },
      { issue: "Пропускает", price: "цена не указана" },
      { issue: "Петляет", price: "цена не указана" },
      { issue: "Стучит", price: "цена не указана" },
      { issue: "Медленно шьет", price: "цена не указана" },
      { issue: "Заклинило", price: "цена не указана" },
      { issue: "Ошибка на дисплее", price: "цена не указана" },
      { issue: "Замена ножей", price: "цена не указана" },
      { issue: "Замена петлителей", price: "цена не указана" },
      { issue: "Профессиональное сервисное обслуживание", price: "<span>8500</span>"}
    ]},
  {opt: "Коверлок",
    optDetails: [
      { issue: "Рвет нить", price: "цена не указана" },
      { issue: "Не опускается лапка", price: "цена не указана" },
      { issue: "Пропускает", price: "цена не указана" },
      { issue: "Петляет", price: "цена не указана" },
      { issue: "Стучит", price: "цена не указана" },
      { issue: "Медленно шьет", price: "цена не указана" },
      { issue: "Заклинило", price: "цена не указана" },
      { issue: "Ошибка на дисплее", price: "цена не указана" },
      { issue: "Замена ножей", price: "цена не указана" },
      { issue: "Замена петлителей", price: "цена не указана" },
      { issue: "Профессиональное сервисное обслуживание", price: "<span>12500</span>"}
    ]},
  {opt: "Плоскошовная (распошивальная)",
    optDetails: [
      { issue: "Рвет нить", price: "цена не указана" },
      { issue: "Не опускается лапка", price: "цена не указана" },
      { issue: "Пропускает", price: "цена не указана" },
      { issue: "Петляет", price: "цена не указана" },
      { issue: "Стучит", price: "цена не указана" },
      { issue: "Медленно шьет", price: "цена не указана" },
      { issue: "Заклинило", price: "цена не указана" },
      { issue: "Ошибка на дисплее", price: "цена не указана" },
      { issue: "Замена ножей", price: "цена не указана" },
      { issue: "Замена петлителей", price: "цена не указана" }
    ]},
  {opt: "Другая",
    optDetails: [
      { issue: "Другая неисправность", price: "цена не указана" },
    ]}
];
const PROMISHLENNAYA = [
  {opt: "Ручная",
  optDetails: [
    { issue: "Рвет нить", price: "цена не указано" },
    { issue: "Не опускается лапка", price: "цена не указано" },
    { issue: "Пропускает", price: "цена не указано" },
    { issue: "Петляет", price: "цена не указано" },
    { issue: "Стучит", price: "цена не указано" },
    { issue: "Медленно шьет", price: "цена не указано" },
    { issue: "Заклинило", price: "цена не указано" }
  ]},
  {opt: "Оверлок",
  optDetails: [
    { issue: "Рвет нить", price: "цена не указано" },
    { issue: "Не опускается лапка", price: "цена не указано" },
    { issue: "Пропускает", price: "цена не указано" },
    { issue: "Петляет", price: "цена не указано" },
    { issue: "Стучит", price: "цена не указано" },
    { issue: "Медленно шьет", price: "цена не указано" },
    { issue: "Заклинило", price: "цена не указано" },
    { issue: "Ошибка на дисплее", price: "цена не указано" },
    { issue: "Замена ножей", price: "цена не указано" },
    { issue: "Замена петлителей", price: "цена не указано" }
  ]},
  {opt: "Плоскошовная (распошивальная)",
  optDetails: [
    { issue: "Рвет нить", price: "цена не указано" },
    { issue: "Не опускается лапка", price: "цена не указано" },
    { issue: "Пропускает", price: "цена не указано" },
    { issue: "Петляет", price: "цена не указано" },
    { issue: "Стучит", price: "цена не указано" },
    { issue: "Медленно шьет", price: "цена не указано" },
    { issue: "Заклинило", price: "цена не указано" },
    { issue: "Ошибка на дисплее", price: "цена не указано" },
    { issue: "Замена ножей", price: "цена не указано" },
    { issue: "Замена петлителей", price: "цена не указано" }
  ]},
  {opt: "Закрепочная",
  optDetails: [
    { issue: "Рвет нить", price: "цена не указано" },
    { issue: "Не опускается лапка", price: "цена не указано" },
    { issue: "Пропускает", price: "цена не указано" },
    { issue: "Петляет", price: "цена не указано" },
    { issue: "Стучит", price: "цена не указано" },
    { issue: "Медленно шьет", price: "цена не указано" },
    { issue: "Заклинило", price: "цена не указано" }
  ]},
  {opt: "Колонковая",
  optDetails: [
    { issue: "Рвет нить", price: "цена не указано" },
    { issue: "Не опускается лапка", price: "цена не указано" },
    { issue: "Пропускает", price: "цена не указано" },
    { issue: "Петляет", price: "цена не указано" },
    { issue: "Стучит", price: "цена не указано" },
    { issue: "Медленно шьет", price: "цена не указано" },
    { issue: "Заклинило", price: "цена не указано" }
  ]},
  {opt: "Петельная",
  optDetails: [
    { issue: "Рвет нить", price: "цена не указано" },
    { issue: "Не опускается лапка", price: "цена не указано" },
    { issue: "Пропускает", price: "цена не указано" },
    { issue: "Петляет", price: "цена не указано" },
    { issue: "Стучит", price: "цена не указано" },
    { issue: "Медленно шьет", price: "цена не указано" },
    { issue: "Заклинило", price: "цена не указано" }
  ]},
  {opt: "Флэтлок",
  optDetails: [
    { issue: "Рвет нить", price: "цена не указано" },
    { issue: "Не опускается лапка", price: "цена не указано" },
    { issue: "Пропускает", price: "цена не указано" },
    { issue: "Петляет", price: "цена не указано" },
    { issue: "Стучит", price: "цена не указано" },
    { issue: "Медленно шьет", price: "цена не указано" },
    { issue: "Заклинило", price: "цена не указано" }
  ]},
  {opt: "Рукавная",
  optDetails: [
    { issue: "Рвет нить", price: "цена не указано" },
    { issue: "Не опускается лапка", price: "цена не указано" },
    { issue: "Пропускает", price: "цена не указано" },
    { issue: "Петляет", price: "цена не указано" },
    { issue: "Стучит", price: "цена не указано" },
    { issue: "Медленно шьет", price: "цена не указано" },
    { issue: "Заклинило", price: "цена не указано" }
  ]},
  {opt: "Вышивальная",
  optDetails: [
    { issue: "Рвет нить", price: "цена не указано" },
    { issue: "Не опускается лапка", price: "цена не указано" },
    { issue: "Пропускает", price: "цена не указано" },
    { issue: "Петляет", price: "цена не указано" },
    { issue: "Стучит", price: "цена не указано" },
    { issue: "Медленно шьет", price: "цена не указано" },
    { issue: "Заклинило", price: "цена не указано" }
  ]},
  {opt: "Стегальная",
  optDetails: [
    { issue: "Рвет нить", price: "цена не указано" },
    { issue: "Не опускается лапка", price: "цена не указано" },
    { issue: "Пропускает", price: "цена не указано" },
    { issue: "Петляет", price: "цена не указано" },
    { issue: "Стучит", price: "цена не указано" },
    { issue: "Медленно шьет", price: "цена не указано" },
    { issue: "Заклинило", price: "цена не указано" }
  ]},
  {opt: "П-образной платформой",
  optDetails: [
    { issue: "Рвет нить", price: "цена не указано" },
    { issue: "Не опускается лапка", price: "цена не указано" },
    { issue: "Пропускает", price: "цена не указано" },
    { issue: "Петляет", price: "цена не указано" },
    { issue: "Стучит", price: "цена не указано" },
    { issue: "Медленно шьет", price: "цена не указано" },
    { issue: "Заклинило", price: "цена не указано" }
  ]},
  {opt: "Пуговичная",
  optDetails: [
    { issue: "Неисправность Пуговичная", price: "цена не указано" },
  ]},
  {opt: "Специальная",
  optDetails: [
    { issue: "Рвет нить", price: "цена не указано" },
    { issue: "Не опускается лапка", price: "цена не указано" },
    { issue: "Пропускает", price: "цена не указано" },
    { issue: "Петляет", price: "цена не указано" },
    { issue: "Стучит", price: "цена не указано" },
    { issue: "Медленно шьет", price: "цена не указано" },
    { issue: "Заклинило", price: "цена не указано" }
  ]},
  {opt: "Другая",
  optDetails: [
    { issue: "Рвет нить", price: "цена не указано" },
    { issue: "Не опускается лапка", price: "цена не указано" },
    { issue: "Пропускает", price: "цена не указано" },
    { issue: "Петляет", price: "цена не указано" },
    { issue: "Стучит", price: "цена не указано" },
    { issue: "Медленно шьет", price: "цена не указано" },
    { issue: "Заклинило", price: "цена не указано" }
  ]}
];

const mainOptions = {
  "_opt-bitovaya": typeof BITOVAYA !== "undefined" ? BITOVAYA : [],
  "_opt-promish": typeof PROMISHLENNAYA !== "undefined" ? PROMISHLENNAYA : []
};

let selects = [];

document.addEventListener("DOMContentLoaded", () => {
  selects = [...document.querySelectorAll("._select-item")];

  selects.forEach(select => {
    const selectedOptionSpan = select.querySelector("[data-from-selectedOption]");
    const selectedSuboptionSpan = select.querySelector("[data-from-selectedSuboption]");
    const wrap = select.querySelector(".js-calcOptions__wrap");
    if (!wrap) return;
    wrap.querySelectorAll("._select-item__suboptions").forEach(n => n.remove());

    Object.keys(mainOptions).forEach(key => {
      const ul = document.createElement("ul");
      ul.classList.add("_select-item__suboptions");
      ul.dataset.optionList = key;
      if (key === "_opt-bitovaya") ul.classList.add("_active");

      (mainOptions[key] || []).forEach((obj, i) => {
        const li = document.createElement("li");
        li.classList.add("_select-item__suboption");
        if (i === 0 && key === "_opt-bitovaya") li.classList.add("_selected");
        li.textContent = obj.opt;
        ul.appendChild(li);
      });

      wrap.appendChild(ul);
    });

    const mainSelected = select.querySelector("._select-item__option._selected");
    if (mainSelected) selectedOptionSpan.textContent = mainSelected.textContent;

    const subSelected =
      select.querySelector("._select-item__suboption._selected") ||
      select.querySelector("._select-item__suboption");

    if (subSelected) selectedSuboptionSpan.textContent = subSelected.textContent;

    renderGlobalIssuesFor(select, subSelected, mainOptions);
  });

  // price must be empty on load
  const priceElement = document.getElementById("price");
  if (priceElement) priceElement.textContent = "";
});

document.addEventListener("click", e => {
  // Remove _visible if any option or issue changed
  const optionChanged =
    e.target.closest("._select-item__option") ||
    e.target.closest("._select-item__suboption") ||
    e.target.closest("._select-item__issue");

  if (optionChanged) {
    const wrap = document.querySelector(".js-calc-price-wrap");
    if (wrap) wrap.classList.remove("_visible");
  }
  selects.forEach(select => {
    const btn = select.querySelector("._select-item__btn");
    const selectedOptionSpan = select.querySelector("[data-from-selectedOption]");
    const selectedSuboptionSpan = select.querySelector("[data-from-selectedSuboption]");

    if (btn?.contains(e.target)) {
      select.classList.toggle("_toggled");
      return;
    }

    const mainOption = e.target.closest("._select-item__option");
    if (mainOption && select.contains(mainOption)) {
      const target = mainOption.dataset.targetOption;

      select.querySelectorAll("._select-item__option").forEach(o => o.classList.remove("_selected"));
      mainOption.classList.add("_selected");
      selectedOptionSpan.textContent = mainOption.textContent;

      select.querySelectorAll("._select-item__suboptions").forEach(list => {
        const active = list.dataset.optionList === target;
        list.classList.toggle("_active", active);

        if (active) {
          const first = list.querySelector("._select-item__suboption");
          list.querySelectorAll("._select-item__suboption").forEach(s => s.classList.remove("_selected"));
          if (first) {
            first.classList.add("_selected");
            selectedSuboptionSpan.textContent = first.textContent;
            renderGlobalIssuesFor(select, first, mainOptions);
          }
        }
      });

      return;
    }

    const subOption = e.target.closest("._select-item__suboption");
    if (subOption && select.contains(subOption)) {
      select.querySelectorAll("._select-item__suboption").forEach(o => o.classList.remove("_selected"));
      subOption.classList.add("_selected");
      selectedSuboptionSpan.textContent = subOption.textContent;

      renderGlobalIssuesFor(select, subOption, mainOptions);
      return;
    }

    if (!select.contains(e.target)) select.classList.remove("_toggled");
  });

  // Select issue on click
  const issue = e.target.closest("._select-item__issue");
  if (issue) {
    document.querySelectorAll("._select-item__issue").forEach(i => i.classList.remove("_selected"));
    issue.classList.add("_selected");

    // --- UPDATE issue button on selecting issue ---
    const btnIssue = document.querySelector(".js-issue-selected");
    if (btnIssue) btnIssue.textContent = issue.textContent;

    return;
  }
  // Update price on button click ONLY
  const btnPrice = e.target.closest(".js-calcPrice__btn");
    if (btnPrice) {
      const selectedIssue = document.querySelector("._select-item__issue._selected");
      const priceElement = document.getElementById("calcPrice");
      priceElement.innerHTML = selectedIssue ? selectedIssue.dataset.price : "";

      // SHOW price block
      const wrap = document.querySelector(".js-calc-price-wrap");
      if (wrap) wrap.classList.add("_visible");
    }

});
function renderGlobalIssuesFor(select, subOptionEl, mainOptions) {
  const activeMain = select.querySelector("._select-item__option._selected");
  if (!activeMain) return;

  const mainKey = activeMain.dataset.targetOption;
  const mainData = mainOptions[mainKey] || [];

  const subItems = [
    ...select.querySelectorAll(`._select-item__suboptions[data-option-list="${mainKey}"] ._select-item__suboption`)
  ];
  const subIndex = subItems.indexOf(subOptionEl);
  if (subIndex === -1) return;

  const optObj = mainData[subIndex];
  const issues = optObj?.optDetails || [];

  const list = document.querySelector("#_select-item__option-list");
  const issueSelected = document.querySelector(".js-issue-selected");
  if (!list) return;

  list.innerHTML = "";
  issues.forEach((item, i) => {
    const li = document.createElement("li");
    li.classList.add("_select-item__issue");
    li.textContent = item.issue;
    li.dataset.price = item.price;
    if (i === 0) li.classList.add("_selected");
    list.appendChild(li);
  });

  // update price
  const priceElement = document.getElementById("calcPrice");
  if (priceElement) priceElement.textContent = "";

  // --- NEW: update issue button ---
  const btnIssue = document.querySelector(".js-issue-selected");
  if (btnIssue && issues.length > 0) {
    btnIssue.textContent = issues[0].issue;
  }
}

